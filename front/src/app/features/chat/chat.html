<div class="chat-container">
  @if (authService.currentUser$ | async; as user) {
    
    <aside class="sidebar">
      <div class="sidebar-header">
        <button routerLink="/home" class="btn-back">‚Üê Retour</button>
        @if (user.role === 'ROLE_USER') {
          <button class="btn-new" (click)="createNewTicket()">+ Nouveau Chat</button>
        } @else {
          <h2 class="sidebar-title">Support Console</h2>
        }
      </div>

      <div class="ticket-list">
        @if (user.role === 'ROLE_AGENT') {
          
          <div class="list-section" [class.collapsed]="!sectionsOpen.unassigned">
            <div class="section-header" (click)="toggleSection('unassigned')">
              <label>√Ä TRAITER (2)</label>
              @if (sectionsOpen.unassigned) {
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
              }            
            </div>
            @if (sectionsOpen.unassigned) {
              <div class="section-content">
                <div class="ticket-item" (click)="selectTicket(42)">#42 - Micka</div>
                <div class="ticket-item" (click)="selectTicket(43)">#43 - Sarah</div>
              </div>
            }
          </div>

          <div class="list-section" [class.collapsed]="!sectionsOpen.mine">
            <div class="section-header" (click)="toggleSection('mine')">
              <label>MES CHATS (1)</label>
              @if (sectionsOpen.mine) {
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
              }             </div>
            @if (sectionsOpen.mine) {
              <div class="section-content">
                <div class="ticket-item" (click)="selectTicket(39)">#39 - Sophie</div>
              </div>
            }
          </div>

          <div class="list-section" [class.collapsed]="!sectionsOpen.archived">
            <div class="section-header" (click)="toggleSection('archived')">
              <label>ARCHIVES</label>
              @if (sectionsOpen.archived) {
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
              } 
            </div>
            @if (sectionsOpen.archived) {
              <div class="section-content">
                <div class="ticket-item archived" (click)="selectTicket(12)">#12 - Jean</div>
              </div>
            }
          </div>

        } @else {
          <div class="list-section" [class.collapsed]="!sectionsOpen.active">
            <div class="section-header" (click)="toggleSection('active')">
              <label>MES √âCHANGES EN COURS</label>
              @if (sectionsOpen.active) {
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
              }
            </div>
            @if (sectionsOpen.active) {
              <div class="section-content">
                <div class="ticket-item" (click)="selectTicket(101)">Ma demande actuelle</div>
              </div>
            }
          </div>

          <div class="list-section" [class.collapsed]="!sectionsOpen.closedClient">
            <div class="section-header" (click)="toggleSection('closedClient')">
              <label>HISTORIQUE (CLOS)</label>
              @if (sectionsOpen.closedClient) {
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
              }
            </div>
            @if (sectionsOpen.closedClient) {
              <div class="section-content">
                <div class="ticket-item archived" (click)="selectTicket(99)">Chat du 05/02/2026</div>
              </div>
            }
          </div>
        }
      </div>
    </aside>

    <main class="chat-window">
      @if (selectedTicketId) {
        <header class="chat-header">
          <div class="ticket-info">
            <h3>Discussion #{{selectedTicketId}}</h3>
          </div>
          @if (user.role === 'ROLE_AGENT') {
            <button class="btn-close-ticket">Fermer le ticket</button>
          }
        </header>

        <div class="messages-container">
          @for (msg of activeMessages; track msg.id) {
            <div class="message" 
                [class.sent]="msg.senderId === user.id" 
                [class.received]="msg.senderId !== user.id">
              
              <div class="bubble">
                {{ msg.text }}
              </div>
              <span class="time">{{ msg.timestamp }}</span>
            </div>
          }
        </div>

        <footer class="chat-input-area">
          <input type="text" placeholder="√âcrivez votre message ici..." [disabled]="isClosed">
          <button class="btn-send">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
          </button>
        </footer>
      } @else {
        <div class="empty-state">
          <div class="icon">üí¨</div>
          <p>S√©lectionnez une conversation pour commencer √† √©changer.</p>
        </div>
      }
    </main>

  }
</div>