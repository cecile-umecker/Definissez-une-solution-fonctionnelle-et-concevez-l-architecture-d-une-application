<div class="chat-container">
  @if (authService.currentUser$ | async; as user) {
    
    <aside class="sidebar">
      <div class="sidebar-header">
        <button routerLink="/home" class="btn-back">‚Üê Retour</button>
        @if (user.role === 'ROLE_USER') {
          <button class="btn-new" (click)="createNewTicket()">+ Nouveau Chat</button>
        } @else {
          <h2 class="sidebar-title">Support Console</h2>
        }
      </div>

      <div class="ticket-list">
        @if (user.role === 'ROLE_AGENT') {
          <div class="list-section" [class.collapsed]="!sectionsOpen.unassigned">
            <div class="section-header" (click)="toggleSection('unassigned')">
              <label>√Ä TRAITER</label>
              <svg [style.transform]="sectionsOpen.unassigned ? 'rotate(0deg)' : 'rotate(-90deg)'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
            </div>
            @if (sectionsOpen.unassigned) {
              <div class="section-content">
                @for (ticket of userTickets; track ticket.id) {
                  @if (ticket.status) {
                    <div class="ticket-item" [class.active]="selectedTicketId === ticket.id" (click)="selectTicket(ticket.id)">
                      #{{ticket.id}} - {{ticket.subject}}
                    </div>
                  }
                }
              </div>
            }
          </div>

          <div class="list-section" [class.collapsed]="!sectionsOpen.archived">
            <div class="section-header" (click)="toggleSection('archived')">
              <label>ARCHIVES</label>
              <svg [style.transform]="sectionsOpen.archived ? 'rotate(0deg)' : 'rotate(-90deg)'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
            </div>
            @if (sectionsOpen.archived) {
              <div class="section-content">
                @for (ticket of userTickets; track ticket.id) {
                  @if (!ticket.status) {
                    <div class="ticket-item archived" [class.active]="selectedTicketId === ticket.id" (click)="selectTicket(ticket.id)">
                      #{{ticket.id}} - {{ticket.subject}}
                    </div>
                  }
                }
              </div>
            }
          </div>

        } @else {
          <div class="list-section" [class.collapsed]="!sectionsOpen.active">
            <div class="section-header" (click)="toggleSection('active')">
              <label>MES √âCHANGES EN COURS</label>
              <svg [style.transform]="sectionsOpen.active ? 'rotate(0deg)' : 'rotate(-90deg)'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
            </div>
            @if (sectionsOpen.active) {
              <div class="section-content">
                @for (ticket of userTickets; track ticket.id) {
                  @if (ticket.status) {
                    <div class="ticket-item" [class.active]="selectedTicketId === ticket.id" (click)="selectTicket(ticket.id)">
                      #{{ticket.id}} - {{ticket.subject}}
                    </div>
                  }
                }
              </div>
            }
          </div>

          <div class="list-section" [class.collapsed]="!sectionsOpen.closedClient">
            <div class="section-header" (click)="toggleSection('closedClient')">
              <label>HISTORIQUE (CLOS)</label>
              <svg [style.transform]="sectionsOpen.closedClient ? 'rotate(0deg)' : 'rotate(-90deg)'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
            </div>
            @if (sectionsOpen.closedClient) {
              <div class="section-content">
                @for (ticket of userTickets; track ticket.id) {
                  @if (!ticket.status) {
                    <div class="ticket-item archived" [class.active]="selectedTicketId === ticket.id" (click)="selectTicket(ticket.id)">
                      #{{ticket.id}} - {{ticket.subject}}
                    </div>
                  }
                }
              </div>
            }
          </div>
        }
      </div>
    </aside>

    <main class="chat-window">
      @if (selectedTicketId) {
        <header class="chat-header">
          <div class="ticket-info">
            <h3>Discussion #{{selectedTicketId}}</h3>
          </div>
          @if (user.role === 'ROLE_AGENT') {
            <button class="btn-close-ticket">Fermer le ticket</button>
          }
        </header>

        <div class="messages-container">
          @for (msg of activeMessages; track msg.id) {
            <div class="message" 
                [class.sent]="msg.senderId === user.id" 
                [class.received]="msg.senderId !== user.id">
              
              <div class="bubble">
                {{ msg.text }}
              </div>
              <span class="time">{{ msg.timestamp | date: 'HH:mm' }}</span>
            </div>
          }
        </div>

        <footer class="chat-input-area">
          <input 
            type="text" 
            placeholder="√âcrivez votre message ici..." 
            [disabled]="isClosed"
            [(ngModel)]="newMessageText" 
            (keyup.enter)="sendMessage()">
          
          <button class="btn-send" (click)="sendMessage()">
            <svg viewBox="0 0 24 24" width="20" height="20">
              <path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
            </svg>
          </button>
        </footer>
      } @else {
        <div class="empty-state">
          <div class="icon">üí¨</div>
          <p>S√©lectionnez une conversation pour commencer √† √©changer.</p>
        </div>
      }
    </main>
  }
</div>